name: sync-images üê≥
on:
  workflow_dispatch:
  push:
    paths:
      - 'config.yaml'
permissions:
  contents: write
jobs:
  sync-job:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Crane
        run: |
          curl -L https://github.com/google/go-containerregistry/releases/latest/download/go-containerregistry_Linux_x86_64.tar.gz | tar xz -C /usr/local/bin/ crane
          chmod +x /usr/local/bin/crane
      
      - name: Read config yaml
        uses: actions-tools/yaml-outputs@v2
        id: yaml
        with:
          file-path: './config.yaml'

      - name: Aggregate images
        id: aggregate
        run: | 
          images=()
          env_vars=$(env | grep '^source__images__')
          while IFS='=' read -r key value; do
            images+=("$value")
          done <<< "$env_vars"
          echo "source__images=${images[*]}" >> $GITHUB_ENV

      - name: Copy images with Crane
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          # Setup Docker authentication for crane
          echo "${{ secrets.DOCKER_PASSWORD }}" | crane auth login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin "${{ env.target__host }}"
          
          # Extract the array from the environment variable
          images=$(echo ${{ env.source__images }} | tr -d '[]' | tr ',' ' ')

          new_images=()
          for image in $images; do
            new_tag="${{ env.target__host }}/${{ env.target__namespace }}/${image##*/}"
            new_images+=("$new_tag")
            echo "=== Copying image: $image -> $new_tag ==="
            crane copy $image $new_tag --insecure
          done
          echo "target__images=${new_images[*]}" >> $GITHUB_ENV

      - name: Modify README.md
        run: |
          images=$(echo ${{ env.target__images }} | tr -d '[]' | tr ',' ' ')
          timestamp=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          # Preserve historical records by appending instead of overwriting
          if [ ! -f README.md ]; then
            echo "# Docker Image Synchronization History" > README.md
            echo "" >> README.md
          fi
          
          echo "## Sync at $timestamp" >> README.md
          for image in $images; do
            echo "* [$image]()" >> README.md
          done
          echo "" >> README.md

      - name: Commit and push README.md
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add README.md
          git commit -m "Update README.md via GitHub Actions" || true

          git push origin HEAD
